<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body {
        background-color: silver;
      }
      /* .wrapper {
        display: flex;
        align-items: center;
        height: 100vh;
        justify-content: center;
      } */
      canvas {
        /* aspect-ratio: 16/9; */
        width: 65%;
        border: 1px solid green;
      }
    </style>

    <script type="module">
      const SIZE_OF_INT = 4;
      const width = 135;
      const height = 67;
      const canvas = document.getElementById("screenCanvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.imageSmoothingEnabled = false;

      async function bootstrap() {
        const { instance } = await WebAssembly.instantiateStreaming(
          fetch("./6502.wasm")
        );

        // Get local versions of our C exports
        // note "memory" - gets a reference to all of the C memory
        const { 
          ram, 
          memory, 
          read6502, 
          write6502,
          reset6502,
          exec6502,
          step6502,
          irq6502,
          nmi6502,
          hookexternal,
        } = instance.exports;

        // have C call malloc to reserve some memory for our screen buffer
        // the data will be stored in the BUFFER variable pointed to in C
        // init(width, height);

        // This is the memory location of where the BUFFER variable starts
        // in the shared memory
        const offset = ram.value;

        // Make a javascript array the memory we are using in the BUFFER
        // variable.
        const screen = new Uint8ClampedArray(
          memory.buffer,      // using the C memory...
          offset,             // at the offset of the ram variable...
          SIZE_OF_INT * height * width // grab enough bytes for all ram
        );

        function hookcallback() {
          console.log("running");
        }
        hookexternal(hookcallback);
        reset6502();

        // Call C to fill our screen buffer. Note we are passing in
        // screen which is a pointer on our side to the BUFFER data
        // on the C side
        // draw(width, height, Date.now(), offset);

        /////////////////////////////////////////////////////////
        // Mess with the shared memory on the JS side
        /////////////////////////////////////////////////////////
        // // const view = new DataView(memory.buffer); // <--- all of the memory
        // const view = new DataView(memory.buffer, offset); // <--- Just our buffer
        // // console.log(view.getUint8(0));
        // for (let x = 0; x < 300; x++) {
        //   // set the first 300px to black
        //   view.setUint8(x, 0x0);
        //   // set the last 300px to black
        //   view.setUint8(SIZE_OF_INT * width * height - x, 0x0);
        // }
        /////////////////////////////////////////////////////////

        // Create an image from our screen data
        const image = new ImageData(screen, height);

        // and render it using the canvas tag
        ctx.putImageData(image, 0, 0);

        // exec6502(0x0000)
        let txt = document.querySelector("#ram");
        ///////////////////////////////////////////
        let start = Date.now();
        const loop = (t) => {
          const current = Date.now();
          const delta = current - start;

          // draw(width, height, delta * 0.05, offset);
          const image = new ImageData(screen, height);
          ctx.putImageData(image, 0, 0);

          step6502();
          // console.log("blarg");
          txt.value = Array.from(screen).map((v,i) => 
            ((i != 0 && (i % 16) == 0) ? '\n' : '')
            + ((i % 16 == 0) ? i.toString(16).padStart(4, '0') + ":\t" : '')
            + v.toString(16).padStart(2, '0') 
          ).join(' ');

          requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
      }

      bootstrap();
    </script>
  </head>
  <body>
    <div class="wrapper">
      <canvas id="screenCanvas"></canvas>
    </div>
    <textarea id="ram" cols="80" rows="40">

    </textarea>
  </body>
</html>
