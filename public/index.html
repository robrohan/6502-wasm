<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body {
        background-color: silver;
      }
      /* .wrapper {
        display: flex;
        align-items: center;
        height: 100vh;
        justify-content: center;
      } */
      canvas {
        /* aspect-ratio: 16/9; */
        width: 25%;
        border: 1px solid green;
      }
      .registers { font-family: 'Courier New', Courier, monospace; }
    </style>

    <script type="module">
      // const SIZE_OF_INT = 2;
      // https://en.wikipedia.org/wiki/Graphics_display_resolution
      const width = 160;
      const height = 120;
      const canvas = document.getElementById("screenCanvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.imageSmoothingEnabled = false;

      async function bootstrap() {
        const { instance } = await WebAssembly.instantiateStreaming(
          fetch("./6502.wasm")
        );

        // Get local versions of our C exports
        // note "memory" - gets a reference to all of the C memory
        const {
          zp,
          ram, 
          io,
          rom,
          stack,
          memory, 
          read6502, 
          write6502,
          reset6502,
          exec6502,
          step6502,
          irq6502,
          nmi6502,
          pc,
          sp, 
          a, 
          x, 
          y, 
          status,
        } = instance.exports;

        ////////////////////////////////////////////////////////////
        // Load rom via http
        {
          const response = await fetch("rom.bin");
          const rom_bin = await response.arrayBuffer();
          const rom_view = new DataView(rom_bin, 0, 0x8000);
          // copy rom data into emulator rom area
          const chip_rom = new DataView(memory.buffer, rom.value, 0x8000);
          chip_rom.setUint8(0, 0xff);
          for (let i = 0; i < 0x8000; i++) {
            chip_rom.setUint8(i, rom_view.getUint8(i));
          }
        }
        ////////////////////////////////////////////////////////////

        // Reset the chip (jump to the new rom)
        reset6502();

        // This is the memory location of where the BUFFER variable starts
        // in the shared memory
        const MEM_START=0x2000; // Just used in mem dump display 
        const MEM_SIZE=0x6000;
        const mem6502 = new Uint8ClampedArray(
          memory.buffer,      // using the C memory...
          io.value,           // at the offset of the ram variable...
          MEM_SIZE            // grab enough bytes for all ram
        );

        /////////////////////////////////////////////
        const screen = new Uint8ClampedArray(
          memory.buffer,        // using the C memory...
          io.value,             // at the offset of the ram variable...
          0x6000                // grab enough bytes for all ram
        );
        const screen_view = new DataView(memory.buffer, io.value, 0x6000);

        const display = new Uint8ClampedArray(height * width * 3);
        const display_view = new DataView(display.buffer, 0, height * width * 3);

        ///////////////////////////////////////////
        // Registers for the processor
        const i_pc = new DataView(memory.buffer, pc.value, 2);
        const i_sp = new DataView(memory.buffer, sp.value, 2);
        const i_a = new DataView(memory.buffer, a.value, 1);
        const i_x = new DataView(memory.buffer, x.value, 1);
        const i_y = new DataView(memory.buffer, y.value, 1);
        const i_fg = new DataView(memory.buffer, status.value, 1);
        const txt = document.querySelector("#ram");
        const pc_dom = document.querySelector("#pc");
        const sp_dom = document.querySelector("#sp");
        const x_dom = document.querySelector("#x");
        const y_dom = document.querySelector("#y");
        const a_dom = document.querySelector("#a");
        const fg_dom = document.querySelector("#fg");
        ///////////////////////////////////////////

        {
          let start = Date.now();
          const loop = (t) => {
            const current = Date.now();
            const delta = current - start;

            /////////////////////////////////////////////////
            // Step processor
            // 1 MHz to 3 MHz
            // 60fps   == 60Hz
            // *1000   == .06MHz (60KHz)
            // *10000  == .6MHz (600KHz)
            // +400000 == 1MHz (low end)
            // *3      == 3MHz (high end)
            for(let i = 0; i < 410000; i++) {
              step6502();
            }

            /////////////////////////////////////////////////
            // Render IO area to the screen
            let stride = 0;
            for (let i = 0; i < 0x6000; i++) {
              const c = screen_view.getUint8(i);
              display_view.setUint8(stride+0, c);
              display_view.setUint8(stride+1, c >> 1);
              display_view.setUint8(stride+2, c >> 2);
              stride = i+3;
            }
            const image = new ImageData(display, width);
            ctx.putImageData(image, 0, 0);
            
            /////////////////////////////////////////////////
            // Display memory area
            txt.value = Array.from(mem6502).map((v,i) => 
              ((i != 0 && (i % 16) == 0) ? '\n' : '')
              + ((i % 16 == 0) ? (i + MEM_START).toString(16).padStart(4, '0') + ":\t" : '')
              + v.toString(16).padStart(2, '0') 
            ).join(' ');

            pc_dom.innerHTML = `$${i_pc.getUint8(1).toString(16).padStart(2, '0')}${i_pc.getUint8(0).toString(16).padStart(2, '0')}`;
            sp_dom.innerHTML = `$${i_sp.getUint8(1).toString(16).padStart(2, '0')}${i_sp.getUint8(0).toString(16).padStart(2, '0')}`;
            a_dom.innerHTML = `$${i_a.getUint8(0).toString(16).padStart(2, '0')}`;
            x_dom.innerHTML = `$${i_x.getUint8(0).toString(16).padStart(2, '0')}`;
            y_dom.innerHTML = `$${i_y.getUint8(0).toString(16).padStart(2, '0')}`;
            fg_dom.innerHTML = `${i_fg.getUint8(0).toString(2).padStart(8, '0')}`;
            /////////////////////////////////////////////////

            requestAnimationFrame(loop);
          };
          requestAnimationFrame(loop);
        }
      }

      bootstrap();
    </script>
  </head>
  <body>
    <div class="wrapper">
      <canvas id="screenCanvas"></canvas>
    </div>

    <div class="registers">
      <div>pc=<span id="pc"></span></div>
      <div>&nbsp;a=<span id="a"></span></div>
      <div>&nbsp;x=<span id="x"></span></div>
      <div>&nbsp;y=<span id="y"></span></div>
      <div>sp=<span id="sp"></span></div>
      <div>&nbsp;&nbsp;&nbsp;<span title="negative, overflow, break, decimal, interrupt, zero, carry">NV-BDIZC</span></div>
      <div>fg=<span id="fg"></span></div>
    </div>
    <textarea id="ram" cols="80" rows="40"></textarea>
  </body>
</html>
